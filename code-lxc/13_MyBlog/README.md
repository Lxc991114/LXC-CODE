# å‰åç«¯åˆ†ç¦»çš„å¼€å‘æ¨¡å¼ï¼ˆæ‰€æœ‰å®‰è£…çš„ä¸œè¥¿éƒ½å¯ä»¥å»npm.jså®˜ç½‘æœç´¢ï¼‰
## ä¸€.ä½¿ç”¨å‰åç«¯è„šæ‰‹æ¶
1.å‰ç«¯ï¼šVue CLI(vueå®˜ç½‘)â€”â€”â€”â€”â€”â€”æ­¤æ¬¡ä½¿ç”¨vue2
ï¼ˆ1ï¼‰å…¨å±€å®‰è£…vue
ï¼ˆ2ï¼‰vue create é¡¹ç›®å
2.åç«¯ï¼škoa-generator(npm.jså®˜ç½‘)â€”â€”â€”â€”â€”â€”æ­¤æ¬¡ä½¿ç”¨koa2
ï¼ˆ1ï¼‰å…¨å±€å®‰è£…koa2
ï¼ˆ2ï¼‰koa2 é¡¹ç›®å
ï¼ˆ3ï¼‰npm installå®‰è£…ä¾èµ–
## äºŒ.å¯¹å‰åç«¯é¡¹ç›®è¿›è¡Œé…ç½®
1.å‰ç«¯ï¼š
ï¼ˆ1ï¼‰å®‰è£…vue-axiosï¼Œåœ¨main.jsä¸­é…ç½®ï¼ˆnpm.jså’Œaxioså®˜ç½‘éƒ½çœ‹çœ‹ï¼‰
2.åç«¯ï¼š
ï¼ˆ1ï¼‰.gitignore(vue clié¡¹ç›®ä¸­è‡ªå¸¦ï¼Œåç«¯å¯é…ç½®ä¸€ä¸ª)
ï¼ˆ2ï¼‰app.jsä¸­ï¼š
ä¸å†éœ€è¦ejsï¼Œå¯å°†å…¶ç›¸å…³é…ç½®åˆ æ‰ï¼›
ä¸å†éœ€è¦viewsæ–‡ä»¶å¤¹ï¼Œåˆ æ‰å…¶ç›¸å…³é…ç½®ï¼›
åˆ é™¤app.jsä¸­å…³äºuser.jsçš„ç›¸å…³è·¯ç”±é…ç½®ï¼Œapp.jsä¸­åªå¼•å…¥index.jsï¼Œå°†user.jsä»¥åŠblog.jsä½œä¸ºindex.jsçš„å­è·¯ç”±ï¼Œå¹¶åœ¨index.jsä¸­é…ç½®ï¼š
const router = require('koa-router')()
const user = require('./users')
const blog = require('./blogs')
router.use('/user', user.routes(), user.allowedMethods())
router.use('/blog', blog.routes(), blog.allowedMethods())
<!-- ä¸Šé¢è¿™ä¸¤è¡Œå¯åœ¨app.jsçš„é…ç½®ä¸­æ‰¾åˆ°ï¼Œä½†æ˜¯è®°å¾—è¦å°†app.useæ”¹æˆrouter.use -->
ï¼ˆ3ï¼‰åˆ›å»ºcontrollersæ–‡ä»¶å¤¹ä»¥åŠmodelsæ–‡ä»¶å¤¹
å®‰è£…koaæ¡†æ¶ä¸­mysqlä¸­é—´ä»¶
å¼•å…¥ä¹‹å‰å†™å¥½çš„db.jså…³äºæ•°æ®åº“çš„æ–‡ä»¶æˆ–è€…å†é…ç½®ä¸€é
ï¼ˆ4ï¼‰å®‰è£…koa-corsä¸­é—´ä»¶å¹¶é…ç½®ï¼šé€‰æ‹©npm.jså®˜ç½‘ä¸­çš„@koa/corsä¸­é—´ä»¶
ã€corsï¼šè·¨åŸŸèµ„æºå…±äº«ï¼Œè§£å†³ajaxåŒæºç­–ç•¥ã€‘â€”â€”â€”â€”â€”â€”â€”â€”å¿˜äº†çš„è¯çœ‹é˜®ä¸€å³°çš„åšå®¢ğŸ‘€

## é‰´æƒé—®é¢˜ï¼ˆtokenï¼šä½¿ç”¨jsonwebtokenä¸­é—´ä»¶ï¼‰
ï¼ˆ 1ï¼‰å‰åç«¯åˆ†ç¦»æ¨¡å¼ä¸èƒ½ç”¨session
ä¼ ç»Ÿçš„å¼€å‘é¡¹ç›®ä¸­ï¼Œä½¿ç”¨sessionï¼Œå¯åœ¨æµè§ˆå™¨çš„cookieä¸­æ”¾å…¥ä¸€ä¸ªsessionçš„idï¼Œæ¯æ¬¡è¯·æ±‚å¸¦ç€sessionçš„idå»æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯æ¥æ”¶è¯·æ±‚çœ‹æ˜¯å¦æœ‰sessionçš„idæ¥åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼Œä½†å‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ä¸­ï¼ŒæœåŠ¡å™¨ç«¯çš„sessionæ²¡åŠæ³•åœ¨å‰ç«¯çš„é¡¹ç›®ä¸­çš„cookieä¸­æ‰”è¿›ä¸€ä¸ªsessionçš„id
å°±åƒç™»é™†ä¹‹ååœ¨8080ç«¯å£çš„æµè§ˆå™¨çš„cookieä¸­æ‰”äº†ä¸€ä¸ªsessionçš„idï¼Œä½†æ˜¯è¯·æ±‚çš„æ—¶å€™ï¼Œæ²¡åŠæ³•ä»8080ç«¯å£å·å¸¦åˆ°3000ç«¯å£å·ï¼Œä¸åŒçš„åŸŸåä¸ä¼šå¸¦è¿‡å»
ï¼ˆ2ï¼‰ä½¿ç”¨token(ä»¤ç‰Œ)åšå‰åç«¯åˆ†ç¦»æ¨¡å¼çš„é‰´æƒ
å®ç°åŸç†ï¼šåœ¨æœåŠ¡å™¨ç«¯ï¼Œä½¿ç”¨jsonwebtokenä¸­é—´ä»¶ï¼Œä¼šç”Ÿæˆä¸€æ®µå”¯ä¸€çš„ç ï¼Œå°†ç ä¼ ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯çš„æ¯ä¸€æ¬¡è¯·æ±‚å…è®¸è‡ªå·±å»é…ç½®æ˜¯å¦å¸¦ç€è¿™ä¸ªç ï¼Œå¸¦è¿‡å»çš„tokenå¿…é¡»æ˜¯æœ‰æ•ˆä¸”æ²¡è¿‡æœŸçš„
ï¼ˆ3ï¼‰tokençš„ä½¿ç”¨
1>åœ¨éœ€è¦ä½¿ç”¨tokençš„é¡µé¢å°†å…¶é…ç½®å¼•å…¥
2>ä¸€æ—¦ç™»å½•æˆåŠŸï¼Œç›´æ¥å»ç”Ÿæˆä¸€ä¸ªtokençš„ï¼šjwt.sign()
jwt.sign(payload, secretOrPrivateKey, [options, callback])
payloadï¼šæ˜¯ä¸ªå¯¹è±¡ï¼Œå¾€tokené‡Œé¢å­˜çš„ä¸œè¥¿
secretOrPrivateKeyï¼šå¯†é’¥ï¼Œè¶Šé•¿è¶Šå¤æ‚è¶Šå¥½
optionsï¼šæ˜¯ä¸ªå¯¹è±¡ï¼Œæ”¯æŒä¼ å¾ˆå¤šå‚æ•°ï¼Œå¸¸ç”¨çš„æœ‰expiresInï¼Œæ¯”å¦‚è®¾ç½®tokençš„æœ‰æ•ˆæ—¶é—´ï¼Œå¦‚{ expiresIn:2 }
3>å°†tokenä½œä¸ºå‚æ•°ä¼ ç»™å‰ç«¯ï¼šæœ€å¥½ç”¨ctx.body = {state:'success',token},è€Œä¸æ˜¯ctx.body = tokenï¼Œå‰ç«¯åˆ¤æ–­çš„æ—¶å€™åˆ¤æ–­çš„æ˜¯state
4>ä¼ ç»™å‰ç«¯åï¼Œåœ¨å‰ç«¯ä»£ç ä¸­å°†tokenå­˜åœ¨local storage(ç¼“å­˜)ä¸­ï¼šlocalStorage.setItem('tokençš„å'ï¼Œåç«¯ä¼ è¿‡æ¥çš„token)
5>æœ€å¥½å“ªä¸ªé¡µé¢éœ€è¦éªŒè¯æ˜¯å¦æœ‰tokenï¼Œå°±åœ¨å“ªä¸ªé¡µé¢å£°æ˜ä¸€ä¸ªéªŒè¯tokençš„æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨created()å£°æ˜å‘¨æœŸå†…è°ƒç”¨ 
å°†tokenå–å‡ºæ¥ï¼šlocalStorage.getItem('tokençš„å')
ã€tokenä¸æ˜¯æ¯æ¬¡å‘é€è¯·æ±‚çš„æ—¶å€™è‡ªåŠ¨å¸¦ç€ï¼Œéœ€è¦çš„æ—¶å€™è¦æ‰‹åŠ¨å¸¦ç€ã€‘
åœ¨axiosè¯·æ±‚ä¸­é™¤äº†methodä»¥åŠurlå¤–ï¼Œè¿˜éœ€è¦å¸¦ä¸Š
headersï¼š{
    'Authorization':localStorage.getItem('tokençš„å')
}
æ­¤æ—¶åœ¨åç«¯é€šè¿‡ctx.header.authorizationè·å¾—å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„tokenå¹¶è¿›è¡ŒéªŒè¯ï¼š
jwt.verify(ä¼ è¿‡æ¥çš„tokenï¼Œç”Ÿæˆtokenæ—¶çš„å¯†é’¥)
ä¸ºäº†çŸ¥é“éªŒè¯æ˜¯å¦æˆåŠŸï¼Œå¤–é¢å¯ä»¥å¥—ç€tryã€catch
try{
    è·å¾—headersä¸­ä¼ è¿‡æ¥çš„tokençš„æ“ä½œ
    jwt.verify(ä¼ è¿‡æ¥çš„tokenï¼Œç”Ÿæˆtokenæ—¶çš„å¯†é’¥)â€”â€”â€”â€”â€”â€”â€”â€”å…¶å®å°±æ˜¯æ ¹æ®ä¸¤ä¸ªå€¼è§£å¯†çš„è¿‡ç¨‹
    ctx.body = {
        state:'success'
    }
}catch(err){
    //é‰´æƒå¤±è´¥ä¹Ÿä¸å»ºè®®ç®€å•çš„è¿”å›ä¸€ä¸ªfail,å¯ä»¥è®¾ç½®çŠ¶æ€ç 401å‘ŠçŸ¥å‰ç«¯é‰´æƒå¤±è´¥
    ctx.status = 401
    ctx.body = {
        state:'fail'
    }
}
å‰ç«¯æ¥æ”¶åˆ°tokenéªŒè¯çš„ä¿¡æ¯åï¼Œæœ€å¥½å†è¿›è¡Œåˆ¤æ–­ï¼š
let {state}=res.data
if(state==='fail'){
    this.$router.push('/login')
}
## å‰åç«¯
å‰ç«¯res.dataè·å¾—çš„æ˜¯åç«¯ctx.bodyçš„å€¼
åç«¯æœ€å¥½ä¸è¦æŠŠctx.bodyç›´æ¥èµ‹ä¸€ä¸ªå€¼ï¼Œå¦‚successä¼ ç»™å‰ç«¯ï¼Œè€Œæ˜¯ä»¥å¯¹è±¡çš„å½¢å¼åé¦ˆç»™å‰ç«¯
ctx.body = {
    state:'success'
    å…¶ä»–éœ€è¦ä¼ çš„å‚æ•°
}

